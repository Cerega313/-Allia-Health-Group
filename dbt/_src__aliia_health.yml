sources:
  - name: lifefile
    description: Raw data ingested from LifeFile via SFTP → GCS → Cloud Function into BigQuery. 
    database: lifefile
    schema: raw_lifefile

    tables:
      - name: payments_raw
        description:  LifeFile payment events as delivered in daily batch files. One row = one payment event 
        columns:
          - name: payment_id
            description: "Unique identifier of the payment event (row) in LifeFile."
            tests:
              - not_null
              - unique

          - name: order_id
            description: Reference to the associated order/prescription. The order is linked to provider_id in the operational lf_ops_orders table.
            tests:
              - not_null
              
          - name: created_at
            description: Timestamp when the payment record was first created in LifeFile.
            tests:
              - not_null
              
          - name: updated_at
            description: Timestamp when the payment record was last updated in LifeFile. created_at can be equal to updated_at
            tests:
              - not_null
              - updated_not_before_created:
                created_at_col: created_at
                updated_at_col: updated_at
              
          - name: payment_date
            description: Timestamp when Allia Health Group received the payment
            tests:
              - not_null

          - name: posting_date
            description: Accounting posting date for the payment (if different from payment_date). 

          - name: copay_amount
            description: Out-of-pocket amount paid by the patient for this event: copay, coinsurance, deductible. Can be 0 for purely insurance payments, and typically negative for refunds.

          - name: insurance_amount
            description: Amount paid by the third party (f.e. insurance). For cash-only prescriptions this is usually 0. In some setups manufacturer copay assistance or coupons may be included here.

          - name: total_amount
            description: Total amount received by the pharmacy for this payment event.
            tests:
              - not_null
              - dbt_utils.expression_is_true:
                name: total_equals_copay_plus_insurance
                expression: COALESCE(total_amount, 0) - COALESCE(copay_amount, 0) - COALESCE(insurance_amount, 0) = 0

          - name: cost_amount
            description: COGS for this dispense/compound: ingredient/drug acquisition cost, consumables, sometimes direct labor.

          - name: profit_amount
            description: Gross profit for this payment event.
            tests:
              - not_null
              - dbt_utils.expression_is_true:
                name: profit_equals_total_minus_cost
                expression: COALESCE(profit_amount, 0) - (COALESCE(total_amount, 0) - COALESCE(cost_amount, 0) = 0

          - name: payer_type
            description: Type of payer for this event
            tests:
              - not_null
              - accepted_values:
                  values: ['PATIENT', 'INSURANCE', 'OTHER']
                  quote: true

          - name: payer_id
            description: Identifier of the payer entity
            tests:
              - not_null

          - name: payment_method
            description: Payment method used
            tests:
              - accepted_values:
                  values: ['CARD', 'ACH', 'CHECK', 'CASH', 'PORTAL']
                  quote: true

          - name: status
            description: Payment status
            tests:
              - not_null
              - accepted_values:
                  values: ['CAPTURED', 'PENDING', 'REFUNDED', 'VOIDED']
                  quote: true

          - name: is_refund
            description:  Boolean flag indicating whether this row represents a refund or adjustment (amounts usually negative). Useful for filtering.
            tests:
              - not_null

          - name: gcs_uri
            description: Full GCS URI of the source file for this row, used for lineage and linking to the ingestion_log.
